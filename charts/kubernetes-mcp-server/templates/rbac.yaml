{{/*
Generic RBAC resources template.
This allows downstream forks and users to add custom RBAC resources without
modifying upstream templates. Define your RBAC needs in values.yaml under:
  - rbac.extraClusterRoles
  - rbac.extraClusterRoleBindings
  - rbac.extraRoles
  - rbac.extraRoleBindings
*/}}

{{- if .Values.rbac.create }}

{{- range .Values.rbac.extraClusterRoles }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: {{ include "kubernetes-mcp-server.fullname.suffixed" (dict "root" $ "suffix" .name) }}
  labels:
    {{- include "kubernetes-mcp-server.labels" $ | nindent 4 }}
    {{- with .labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .annotations }}
  annotations:
    {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
rules:
  {{- toYaml .rules | nindent 2 }}
{{- end }}

{{- range .Values.rbac.extraClusterRoleBindings }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: {{ include "kubernetes-mcp-server.fullname.suffixed" (dict "root" $ "suffix" .name) }}
  labels:
    {{- include "kubernetes-mcp-server.labels" $ | nindent 4 }}
    {{- with .labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .annotations }}
  annotations:
    {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: {{ .roleRef.kind | default "ClusterRole" }}
  {{- if .roleRef.external }}
  name: {{ .roleRef.name }}
  {{- else }}
  name: {{ include "kubernetes-mcp-server.fullname.suffixed" (dict "root" $ "suffix" .roleRef.name) }}
  {{- end }}
subjects:
  {{- if .subjects }}
  {{- toYaml .subjects | nindent 2 }}
  {{- else }}
  - kind: ServiceAccount
    name: {{ include "kubernetes-mcp-server.serviceAccountName" $ }}
    namespace: {{ $.Release.Namespace }}
  {{- end }}
{{- end }}

{{- range .Values.rbac.extraRoles }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: {{ include "kubernetes-mcp-server.fullname.suffixed" (dict "root" $ "suffix" .name) }}
  namespace: {{ .namespace | default $.Release.Namespace }}
  labels:
    {{- include "kubernetes-mcp-server.labels" $ | nindent 4 }}
    {{- with .labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .annotations }}
  annotations:
    {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
rules:
  {{- toYaml .rules | nindent 2 }}
{{- end }}

{{- range .Values.rbac.extraRoleBindings }}
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: {{ include "kubernetes-mcp-server.fullname.suffixed" (dict "root" $ "suffix" .name) }}
  namespace: {{ .namespace | default $.Release.Namespace }}
  labels:
    {{- include "kubernetes-mcp-server.labels" $ | nindent 4 }}
    {{- with .labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .annotations }}
  annotations:
    {{- tpl (toYaml .) $ | nindent 4 }}
  {{- end }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: {{ .roleRef.kind | default "Role" }}
  {{- if .roleRef.external }}
  name: {{ .roleRef.name }}
  {{- else }}
  name: {{ include "kubernetes-mcp-server.fullname.suffixed" (dict "root" $ "suffix" .roleRef.name) }}
  {{- end }}
subjects:
  {{- if .subjects }}
  {{- toYaml .subjects | nindent 2 }}
  {{- else }}
  - kind: ServiceAccount
    name: {{ include "kubernetes-mcp-server.serviceAccountName" $ }}
    namespace: {{ $.Release.Namespace }}
  {{- end }}
{{- end }}

{{- end }}
