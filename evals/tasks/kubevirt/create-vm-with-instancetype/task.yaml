kind: Task
metadata:
  labels:
    suite: kubevirt
    requires: kubevirt
  name: "create-vm-with-instancetype"
  difficulty: easy
steps:
  setup:
    inline: |-
      #!/usr/bin/env bash
      NS="${EVAL_NAMESPACE:-vm-test}"
      kubectl delete namespace "$NS" --ignore-not-found
      kubectl create namespace "$NS"
  verify:
    inline: |-
      #!/usr/bin/env bash
      source ../helpers/verify-vm.sh
      NS="${EVAL_NAMESPACE:-vm-test}"

      # Wait for VirtualMachine to be created
      verify_vm_exists "test-vm-instancetype" "$NS" || exit 1

      # Verify that it has the specific instancetype reference (u1.medium)
      verify_instancetype "test-vm-instancetype" "$NS" "u1.medium" || exit 1

      # Verify runStrategy is set and deprecated 'running' field is not used
      verify_run_strategy "test-vm-instancetype" "$NS" || exit 1
      verify_no_deprecated_running_field "test-vm-instancetype" "$NS" || exit 1

      # Verify no direct resource specification (should use instancetype)
      verify_no_direct_resources "test-vm-instancetype" "$NS"

      # Verify container disk is Fedora (default workload)
      verify_container_disk "test-vm-instancetype" "$NS" "fedora"

      echo "All validations passed"
      exit 0
  cleanup:
    inline: |-
      #!/usr/bin/env bash
      NS="${EVAL_NAMESPACE:-vm-test}"
      kubectl delete virtualmachine test-vm-instancetype -n "$NS" --ignore-not-found
      kubectl delete namespace "$NS" --ignore-not-found
  prompt:
    inline: Create a Fedora virtual machine named test-vm-instancetype in the ${EVAL_NAMESPACE:-vm-test} namespace with instancetype 'u1.medium'.
