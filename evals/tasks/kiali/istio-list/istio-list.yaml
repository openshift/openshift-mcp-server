kind: Task
metadata:
  name: "List all VS in bookinfo namespace"
  category: "Istio Configuration & Management"
  difficulty: easy
steps:
  setup:
    inline: |-
      #!/usr/bin/env bash
      set -euo pipefail
      cat <<'EOF' | kubectl apply -f -
      apiVersion: networking.istio.io/v1alpha3
      kind: VirtualService
      metadata:
        name: productpage-forced-failure
        namespace: bookinfo
        labels:
          gevals.kiali.io/test: delete-fault-injection
      spec:
        hosts:
        - "productpage"
        - "productpage-bookinfo.apps-crc.testing" 
        gateways:
        - bookinfo-gateway
        - mesh # Para que afecte tambiÃ©n si un microservicio llama a otro internamente
        http:
        - fault:
            abort:
              httpStatus: 500
              percentage:
                value: 100
          route:
          - destination:
              host: productpage
              subset: v1
      EOF
  verify:
    contains: "productpage-forced-failure"
  cleanup:
    inline: |-
      #!/usr/bin/env bash  
      set -euo pipefail
      NS="bookinfo"
      LABEL="gevals.kiali.io/test=gevals-testing"
      kubectl delete virtualservice -n "$NS" -l "$LABEL" --ignore-not-found
  prompt:
    inline: List all VirtualServices in the bookinfo namespace and check if they have any validation errors