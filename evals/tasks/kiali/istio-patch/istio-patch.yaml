kind: Task
metadata:
  name: "Patch my traffic"
  category: "Istio Configuration & Management"
  difficulty: medium
steps:
  setup:
    inline: |-
      #!/usr/bin/env bash
      set -euo pipefail
      cat <<'EOF' | kubectl apply -f -
      kind: DestinationRule
      apiVersion: networking.istio.io/v1
      metadata:
        namespace: bookinfo
        name: reviews
        labels:
          gevals.kiali.io/test: gevals-testing
        annotations: ~
      spec:
        host: reviews.bookinfo.svc.cluster.local
        subsets:
        - name: v1
          labels:
            version: v1
        - name: v2
          labels:
            version: v2
        - name: v3
          labels:
            version: v3
        trafficPolicy: ~

      ---

      kind: VirtualService
      apiVersion: networking.istio.io/v1
      metadata:
        namespace: bookinfo
        name: reviews
        labels:
          gevals.kiali.io/test: gevals-testing
      spec:
        http:
        - route:
          - destination:
              host: reviews.bookinfo.svc.cluster.local
              subset: v1
            weight: 0
          - destination:
              host: reviews.bookinfo.svc.cluster.local
              subset: v2
            weight: 0
          - destination:
              host: reviews.bookinfo.svc.cluster.local
              subset: v3
            weight: 100
        hosts:
        - reviews.bookinfo.svc.cluster.local
        gateways: ~
      EOF
  verify:
    inline: |-
      #!/usr/bin/env bash
      set -euo pipefail
      NS="bookinfo"
      LABEL="gevals.kiali.io/test=gevals-testing"
      NAME="reviews"

      if ! command -v jq >/dev/null 2>&1; then
        echo "jq is required for verification"
        exit 1
      fi

      # Fetch the VirtualService by label and name
      vs_json="$(kubectl get virtualservice -n "$NS" -l "$LABEL" -o json)"
      found="$(echo "$vs_json" | jq -r --arg name "$NAME" '.items[]? | select(.metadata.name==$name) | .metadata.name' | head -n1)"
      if [[ "$found" != "$NAME" ]]; then
        echo "VirtualService '$NAME' with label '$LABEL' not found in namespace '$NS'"
        exit 1
      fi

      # Verify there is a route to subset v2 with weight 50
      ok="$(echo "$vs_json" | jq -e --arg name "$NAME" '
        .items[]? | select(.metadata.name==$name)
        | any(.spec.http[]?.route[]?; (.destination.subset=="v2") and ((.weight // 0) == 50))
      ' >/dev/null && echo yes || echo no)"

      if [[ "$ok" != "yes" ]]; then
        echo "VirtualService '$NAME' does not route subset v2 with weight 50"
        echo "Current routes:"
        echo "$vs_json" | jq -r --arg name "$NAME" '
          .items[]? | select(.metadata.name==$name)
          | .spec.http[]?.route[]? | {subset: .destination.subset, weight: .weight}
        '
        exit 1
      fi
      echo "Verified: VirtualService '$NAME' routes subset v2 with weight 50."
  cleanup:
    inline: |-
      #!/usr/bin/env bash  
      set -euo pipefail
      NS="bookinfo"
      LABEL="gevals.kiali.io/test=gevals-testing"
      kubectl delete virtualservice -n "$NS" -l "$LABEL" --ignore-not-found
      kubectl delete destinationrule -n "$NS" -l "$LABEL" --ignore-not-found
  prompt:
    inline: I need to shift 50% of traffic to v2 of the reviews service. Apply a patch to the existing VirtualService.

   