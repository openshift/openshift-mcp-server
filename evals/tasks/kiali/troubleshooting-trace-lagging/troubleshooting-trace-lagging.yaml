kind: Task
metadata:
  name: "Check traces for a service"
  category: "Troubleshooting & Debugging"
  difficulty: easy
steps:
  setup:
    inline: |-
      #!/usr/bin/env bash
      set -euo pipefail
      cat <<'EOF' | kubectl apply -f -
      kind: DestinationRule
      apiVersion: networking.istio.io/v1
      metadata:
        namespace: bookinfo
        name: ratings
        labels:
          gevals.kiali.io/test: delete-fault-injection
        annotations: ~
      spec:
        host: ratings.bookinfo.svc.cluster.local
        subsets:
        - name: v1
          labels:
            version: v1
        trafficPolicy: ~

      ---

      kind: VirtualService
      apiVersion: networking.istio.io/v1
      metadata:
        namespace: bookinfo
        name: ratings
        labels:
          gevals.kiali.io/test: delete-fault-injection
      spec:
        http:
        - route:
          - destination:
              host: ratings.bookinfo.svc.cluster.local
              subset: v1
            weight: 100
          fault:
            delay:
              percentage:
                value: 100
              fixedDelay: 5s
        hosts:
        - ratings.bookinfo.svc.cluster.local
        gateways: ~
      EOF
  verify:
    contains: "ratings"
  cleanup:
    inline: |-
      #!/usr/bin/env bash   
      set -euo pipefail
      NS="bookinfo"
      LABEL="gevals.kiali.io/test=gevals-testing"
      kubectl delete virtualservice -n "$NS" -l "$LABEL" --ignore-not-found
      kubectl delete destinationrule -n "$NS" -l "$LABEL" --ignore-not-found
  prompt:
    inline: I see a spike in duration for ratings. Can you check the traces to see which span is lagging?



   