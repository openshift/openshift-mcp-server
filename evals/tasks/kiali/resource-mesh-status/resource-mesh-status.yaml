kind: Task
metadata:
  labels:
    suite: kiali
  name: "Status of my mesh"
  category: "Resource Inspection"
  difficulty: easy
steps:
  setup: 
    inline: |-
      #!/usr/bin/env bash
      set -euo pipefail
      cat <<'EOF' | kubectl apply -f -
      apiVersion: networking.istio.io/v1
      kind: DestinationRule
      metadata:
        namespace: bookinfo
        name: ratings
        labels:
          gevals.kiali.io/test: delete-fault-injection
      spec:
        host: ratings.bookinfo.svc.cluster.local
        subsets:
        - name: v1
          labels:
            version: v1
      ---
      apiVersion: networking.istio.io/v1
      kind: VirtualService
      metadata:
        namespace: bookinfo
        name: ratings
        labels:
          gevals.kiali.io/test: delete-fault-injection
      spec:
        hosts:
        - ratings.bookinfo.svc.cluster.local
        http:
        - route:
          - destination:
              host: ratings.bookinfo.svc.cluster.local
              subset: v1
            weight: 100
          fault:
            abort:
              percentage:
                value: 100
              httpStatus: 503
      EOF
  verify:
    inline: |-
      #!/usr/bin/env bash
  cleanup: 
    inline: |-
      #!/usr/bin/env bash
      set -euo pipefail
      NS="bookinfo"
      LABEL="gevals.kiali.io/test=gevals-testing"
      kubectl delete virtualservice -n "$NS" -l "$LABEL" --ignore-not-found
      kubectl delete destinationrule -n "$NS" -l "$LABEL" --ignore-not-found          
  prompt:
    inline: Check my mesh.