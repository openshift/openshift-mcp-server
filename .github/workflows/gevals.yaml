name: Gevals MCP Evaluation

on:
  # Weekly schedule - runs every Monday at 9 AM UTC
  schedule:
    - cron: '0 9 * * 1'

  # Manual trigger via PR comments
  issue_comment:
    types: [created]

  # Allow manual workflow dispatch for testing
  workflow_dispatch:
    inputs:
      task-filter:
        description: 'Regular expression to filter tasks (optional)'
        required: false
        default: ''
      verbose:
        description: 'Enable verbose output'
        required: false
        type: boolean
        default: false

# Minimal permissions - no write access to PRs/issues
# This workflow checks out and runs potentially untrusted PR code
permissions:
  contents: read
  actions: read

concurrency:
  # Only run once for latest commit per ref and cancel other (previous) runs.
  # For issue_comment events, use PR number as group to avoid different PRs canceling each other.
  group: ${{ github.workflow }}-${{ github.event_name == 'issue_comment' && format('pr-{0}', github.event.issue.number) || github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: 1.25
  KIND_CLUSTER_NAME: mcp-eval-cluster

defaults:
  run:
    shell: bash

jobs:
  # Check if workflow should run based on trigger
  check-trigger:
    name: Check if evaluation should run
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/run-gevals'))
    outputs:
      should-run: ${{ steps.check.outputs.should-run }}
      kiali-run: ${{ steps.check.outputs.kiali-run }}
      pr-number: ${{ steps.check.outputs.pr-number }}
      pr-sha: ${{ steps.check.outputs.pr-sha }}
      is-pr: ${{ steps.check.outputs.is-pr }}
    steps:
      - name: Check trigger conditions
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ github.event_name }}" == "issue_comment" ]]; then
            # Check if commenter has write access
            PERMISSION=$(gh api "repos/${{ github.repository }}/collaborators/${{ github.event.comment.user.login }}/permission" --jq '.permission')

            if [[ "$PERMISSION" == "admin" || "$PERMISSION" == "write" ]]; then
              echo "should-run=true" >> $GITHUB_OUTPUT
              echo "is-pr=true" >> $GITHUB_OUTPUT
              PR_NUMBER="${{ github.event.issue.number }}"
              echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT

              # Capture SHA at trigger time to prevent TOCTOU race condition
              # This ensures we run the exact code the maintainer reviewed
              PR_SHA=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json headRefOid --jq '.headRefOid')
              echo "pr-sha=$PR_SHA" >> $GITHUB_OUTPUT
              echo "Pinned to SHA: $PR_SHA"
            else
              echo "should-run=false" >> $GITHUB_OUTPUT
              echo "User ${{ github.event.comment.user.login }} does not have permission to trigger evaluations"
            fi
          else
            echo "should-run=true" >> $GITHUB_OUTPUT
            echo "is-pr=false" >> $GITHUB_OUTPUT
            echo "pr-sha=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

          TASK_FILTER="${{ github.event.inputs.task-filter || '' }}"
          if [[ "$TASK_FILTER" =~ kiali ]]; then
            echo "kiali-run=true" >> $GITHUB_OUTPUT
          else
            echo "kiali-run=false" >> $GITHUB_OUTPUT
          fi

  # Run gevals evaluation with Kind cluster
  run-evaluation:
    name: Run MCP Evaluation
    needs: check-trigger
    if: needs.check-trigger.outputs.should-run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          # Use pinned SHA to prevent TOCTOU attacks
          # For PRs: the SHA captured when maintainer commented
          # For other triggers: the current commit SHA
          ref: ${{ needs.check-trigger.outputs.pr-sha }}

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Setup Kind cluster
        run: make kind-create-cluster KIND_CLUSTER_NAME=${{ env.KIND_CLUSTER_NAME }}

      - name: Install Istio/Kiali and bookinfo demo
        if: needs.check-trigger.outputs.kiali-run == 'true'
        run: make setup-kiali

      - name: Start MCP server
        run: make run-server
        env:
          TOOLSETS: ${{ needs.check-trigger.outputs.kiali-run == 'true' && 'kiali' || '' }}

      - name: Run gevals evaluation
        id: gevals
        uses: genmcp/gevals/.github/actions/gevals-action@v0.0.2
        with:
          eval-config: 'evals/openai-agent/eval.yaml'
          gevals-version: 'latest'
          task-filter: ${{ github.event.inputs.task-filter || '' }}
          output-format: 'json'
          verbose: ${{ github.event.inputs.verbose || 'false' }}
          upload-artifacts: 'true'
          artifact-name: 'gevals-results'
          fail-on-error: 'false'
          task-pass-threshold: '0.8'
          assertion-pass-threshold: '0.8'
          working-directory: '.'
        env:
          # OpenAI Agent configuration
          MODEL_BASE_URL: ${{ secrets.MODEL_BASE_URL }}
          MODEL_KEY: ${{ secrets.MODEL_KEY }}
          # LLM Judge configuration
          JUDGE_BASE_URL: ${{ secrets.JUDGE_BASE_URL }}
          JUDGE_API_KEY: ${{ secrets.JUDGE_API_KEY }}
          JUDGE_MODEL_NAME: ${{ secrets.JUDGE_MODEL_NAME }}

      - name: Cleanup
        if: always()
        run: |
          make stop-server || true
          make kind-delete-cluster KIND_CLUSTER_NAME=${{ env.KIND_CLUSTER_NAME }} || true

      # Save context and results for the reporting workflow
      - name: Save evaluation context
        if: always() && needs.check-trigger.outputs.is-pr == 'true'
        run: |
          mkdir -p eval-context
          cat > eval-context/context.json << EOF
          {
            "pr_number": "${{ needs.check-trigger.outputs.pr-number }}",
            "pr_sha": "${{ needs.check-trigger.outputs.pr-sha }}",
            "tasks_passed": "${{ steps.gevals.outputs.tasks-passed }}",
            "tasks_total": "${{ steps.gevals.outputs.tasks-total }}",
            "task_pass_rate": "${{ steps.gevals.outputs.task-pass-rate }}",
            "assertions_passed": "${{ steps.gevals.outputs.assertions-passed }}",
            "assertions_total": "${{ steps.gevals.outputs.assertions-total }}",
            "passed": "${{ steps.gevals.outputs.passed }}"
          }
          EOF

      - name: Upload PR context
        if: always() && needs.check-trigger.outputs.is-pr == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: eval-context
          path: eval-context/
          retention-days: 1
